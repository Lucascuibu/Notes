# 4.Delaunay triangulation And Remeshing

### Voronoi图

回顾昨天对网格的讨论，对于一个曲面，如何生成这样一些网格呢？因为流型，我们可以先讨论2维欧氏平面。我们可以随机的撒下一些点，就像撒盐一样。对于平面上其他的点，找到和这个点距离最近的采样点，归属于他的领地范围。这样我们得到了Voronoi图。
$$
\mathcal{V}\left(\mathbf{p}_i\right)=\left\{\mathbf{x} \in \mathbb{R}^2:\left\|\mathbf{x}-\mathbf{p}_i\right\| \leq\left\|\mathbf{x}-\mathbf{p}_j\right\|, \forall j \neq i\right\}
$$
一个更清晰的方式是对每一对距离为1的点取连线的垂直平分线，这些垂直平分线相交帮助我们定义了Voronoi图。平面上任意点必然可以被Voroni划分。Voroni也可被理解为封闭半空间的相交，这带来一个非常美好的性质，任意voronoi格必定是凸的！我注意到有些地方对凸的定义有些混乱。这里记住他的英文convex，代表集合内任意两点的连线仍然在集合内。

Voronoi还有其他的方式，比如从每个采样点生成一个圆，逐渐扩大所有圆的半径直到相交，这同样满足垂直平分的性质。但是注意到Vornoi格并不总是3角形，实际上，每个格子边的数量由1-ring的数量决定。因此，我们不会想要让voronoi成为三角网格！

### Delaunay图

还记得这些点之间的连线吗，这些连线组成了另外一幅连接性图。对偶的概念又一次出现了。每个以为一维点对偶到面，3维面对偶到点，2维边对偶到边。之前我们比较关注点和面的对偶。这里我们关注边和边的对偶。 对于一个三角形网格我们知道
$$
E\approx 3V = O(n)
$$
Voronoi的对偶正是这样一张图，实际上这一幅连接性图叫做delaunay三角形。这也是我们这节课的重点。由于Voronoi和delaunay的紧密关联，很多的性质都可以互相推导。Vronoi点是dudelaunay三角形的外接圆的圆心，这个外接圆并不会包括其他的采样点，delaunay的这个性质也被称为空球性质(empty sphere property)。 Delaunay三角剖分所有可能的点集P的三角剖分中，能够最大化最小角的一个剖分。这个叫做最小角最大化（Maximization of the Smallest Angle。这个性质还有一个更强的版本，叫做词典序最大化角向量（Maximization of the Angular Vector for Lexicographic Order。指的是在所有可能的点集P的三角剖分中，Delaunay三角剖分的角向量（所有三角形角的集合）在词典序中是最大的。

后面两个性质可能会让你有点困惑，实际上我们思考的是既然可以对曲面生成任意采样点集，那么这些采样点集之间是否有好有坏呢？因为点集直接生成了网格，所以更经常地会称作网格质量。最朴素的思想是我们希望网格是均匀分布的，如果所有的点是均匀的，那么边应该都是差不多长。也就是说所有三角形都几乎是等边三角形！与之相对的是一些狭长的三角形，导致了点分布的不均匀，极大和极小的角度导致三角函数的计算也更加困难，这是我们希望避免的。后两条性质实际上都是说Delaunay是给定采样点下最好的选择。

### 算法

我们来详细的构建一下空球性质，为你的作业提供一些提示。对于一个三角形，如何确定一个采访点是否在该三角形的外借圆内呢。当然有很多种办法，当我希望找出一种高效的矩阵运算而不是纯解析的方法。我们可以假设所有点都在二维平面上，只有 $\{x,y\}$坐标。将 $x^2 + y^2$​ 作为z轴，实际上是把坐标都映射到了这条函数上。映射后的半空中的3点在曲面上组成了一个平面，如果新的点在平面上方，那么在三角形外，反之亦然。
$$
\operatorname{volume}\left(\mathbf{A}^{\prime}, \mathbf{B}^{\prime}, \mathbf{C}^{\prime}, \mathbf{D}^{\prime}\right)=\operatorname{det}\left[\begin{array}{llll}
A_x & A_y & A_x^2+A_y^2 & 1 \\
B_x & B_y & B_x^2+B_y^2 & 1 \\
C_x & C_y & C_x^2+C_y^2 & 1 \\
D_x & D_y & D_x^2+D_y^2 & 1
\end{array}\right]
$$
这个矩阵的行列式也被称为四面体的符号体积。行列式为正，点在平面上方，点在三角形外。相比于解析法，符号体积只需要对坐标进行简单的计算，还能配合矩阵进行优化，所以很高效。

现在我们知道如何判定一个点是否满足Delaunay了，但实际上我们想知道的是这条边是否满足Delaunay。当我们遇到一条不满足Delaunay的边的时候怎么处理呢？我们直接取这条边的对偶。可以证明，对偶之后必定满足Delaunay。最后的一件事如何检测这些边呢？直接遍历一次是不够的，因为一组三角形内部满足Delaunay之后，他的边在其他三角形内部可能不满足Delaunay。所以我们希望建立一个先进后出的数据结构，每次检查之后把组三角形的边推进去。最简单的先进后出FIFO的结构叫做队列Queue。当Queue空之后，整张图便是一张Delaunay三角剖分。

在我们的作业中，我们是用了圆的性质来生产Voronoi图，当你开始鼠标检测后，在规定位置内的点击都在点上放置一个圆锥。调整合适的shader后这些圆锥就像一个圆，他们互相重叠的部分被遮蔽起来，留下的交点就是voronoi点，相交的边组成了voronoi图。接下来你需要根据上面的提示维护队列，检查每条边是否满足Delaunay，直到Queue空。注意到边界边是不包含在内的。

### 提升网格质量

对于我们的平面，我们有了一群随机的采样点和根据采样点集生成的Delaunay三角剖分。但因为是完全随机的，所以大概率会有非常不规则的三角形，这正是我们现在想解决的。这里我们介绍一种最简单的思想，使用蒙特卡洛法实现提升网格质量。

简单来说，蒙特卡洛法指的是在定义域内随机的进行一些采样。比如如何测量pi？给定一个单位圆和他的外接正方形，向正方形内投下大量随机的采样点。统计落在圆内的采样点的数量和总采样点的比值，我们就得到了近似的圆的面积。用圆面积公式即可反推出pi。

蒙特卡洛法在其他很多领域里都有重要的作用，它是无偏估计，避免了维度诅咒，误差也是可控制的。这里我们抛砖引玉，如果你想了解更多有关随机，采样的内容，我会像你推荐Keenan crane的课程。

今天我们使用的实际上是名为Lloyd iteration的迭代法，基于蒙特卡洛法实现。我们像平面投下大量的随机点，并计算这些随机点归属于哪个voronoi格。所有的随机点平均会得到一个近似出来的中心。将voronoi点像这个中心移动。迭代数次后，你会发现Delaunay三角形都将趋于正三角形，voroni diagram也将趋于均匀。这里你可以想象，Delaunay图和voroni图都是一起移动的，所以无需分开处理。

除了今天提到的Lloyd iteration，在DGP中还包括了非常多的改善网格质量的方法。我们在这里不全部解释，但也非常欢迎你自行翻阅并且在评论区提出你的见解。

